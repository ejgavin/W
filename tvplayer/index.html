<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TV Stream Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Rubik:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/artplayer@5.2.3/dist/artplayer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/artplayer-plugin-hls-control@latest/dist/artplayer-plugin-hls-control.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --accent: #2f81f7;
      --text: #c9d1d9;
      --text-light: #8b949e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Rubik', 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--card);
      padding: 1.5rem 2rem;
      font-size: 1.8rem;
      color: var(--accent);
      font-weight: 600;
      border-bottom: 2px solid var(--accent);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .controls {
      display: flex;
      gap: 1rem;
    }
    .controls input, .controls select {
      background: #21262d;
      color: var(--text);
      border: 1px solid #30363d;
      padding: 0.5rem;
      border-radius: 6px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
    }
    .card {
      background: var(--card);
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 1.2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      transition: transform 0.2s ease;
    }
    .card:hover {
      transform: translateY(-6px);
    }
    .card img {
      max-height: 60px;
      object-fit: contain;
      margin-bottom: 1rem;
    }
    .card h3 {
      font-size: 1.2rem;
      margin: 0 0 0.5rem;
      color: var(--accent);
    }
    .schedule {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-bottom: 1rem;
    }
    .watch-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }
    .watch-btn:hover {
      background: #1f6feb;
    }
    #playerModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: #000;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
    }
    #playerHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card);
      padding: 1rem;
      color: var(--text);
    }
    #playerHeader button {
      background: none;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    #playerHeader > div {
      display: flex;
      align-items: center;
    }
    #player {
      flex: 1;
      width: 100vw;
      height: 100%;
    }
    #scheduleSidebar {
      display:none;
      position:absolute;
      top:0;
      right:0;
      width:300px;
      height:100%;
      background:#161b22;
      color:#c9d1d9;
      overflow:auto;
      box-shadow:-4px 0 8px rgba(0,0,0,0.4);
      padding:1rem;
      z-index: 10000;
    }
    #scheduleCloseBtn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      float: right;
      margin-bottom: 0.5rem;
    }
    #goLiveBtn {
      background: var(--accent);
      border: none;
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 1rem;
      display: none;
    }
  </style>
</head>
<body>
  <div id="mainPage">
    <header>
      Live TV Portal
      <div class="controls">
        <input type="text" id="searchBox" placeholder="Search channels...">
        <select id="viewToggle">
          <option value="grid">Grid View</option>
          <option value="list">List View</option>
        </select>
      </div>
    </header>
    <div class="grid" id="channelGrid"></div>
  </div>
  <div id="playerModal" style="display:none;">
    <div id="playerHeader">
      <span id="playerTitle">Now Playing</span><button id="goLiveBtn" onclick="goLive()">Go Live</button>
      <div>
        <button onclick="toggleSchedule()">Schedule</button>
        <button onclick="toggleSettings()">Settings</button>
        <button onclick="closePlayer()">Back</button>
      </div>
    </div>
    <div id="playerSettings" style="display:none; background:var(--card); padding:1rem; color:var(--text); border-top:1px solid var(--accent);">
      <h3 style="margin-top:0;">Player Settings</h3>
      <label style="display:block; margin-bottom:1rem;">
        <input type="checkbox" id="bufferFixToggle"> Fix Buffering<br>
        <small style="color:var(--text-light);">Enable this if the stream is buffering while playing.</small>
      </label>
      <label style="display:block;">
        Theme:
        <select id="themeToggle" style="margin-left:0.5rem; background:#21262d; color:var(--text); border:1px solid #30363d; padding:0.2rem 0.5rem; border-radius:6px;">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </label>
    </div>
    <div id="player"></div>
    <div id="scheduleSidebar" style="display:none; position:absolute; top:0; right:0; width:300px; height:100%; background:#161b22; color:#c9d1d9; overflow:auto; box-shadow:-4px 0 8px rgba(0,0,0,0.4); padding:1rem;">
      <button id="scheduleCloseBtn" style="background:none; border:none; color:#c9d1d9; font-size:1.2rem; cursor:pointer; float:right; margin-bottom:0.5rem;">×</button>
      <div id="scheduleContent"></div>
    </div>
  </div>
  <script>
    let allChannels = [];
    let currentSchedule = null;

    async function loadChannels() {
      const res = await fetch('https://ejgsapis.vercel.app/api/m3u8list');
      const text = await res.text();
      const lines = text.split('\n');

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {
          const title = lines[i].split(',').pop().trim();
          const logoMatch = lines[i].match(/tvg-logo="(.*?)"/);
          const logo = logoMatch ? logoMatch[1] : '';
          const stream = lines[i + 1]?.trim();
          if (stream) {
            allChannels.push({ title, logo, stream });
          }
        }
      }
      renderChannels(allChannels);
      fetchSchedule();
    }

    function renderChannels(channels) {
      const container = document.getElementById('channelGrid');
      container.innerHTML = '';
      channels.forEach(channel => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${channel.logo}" alt="${channel.title}" />
          <h3>${channel.title}</h3>
          <div class="schedule" id="sched-${channel.title}">Loading schedule...</div>
          <button class="watch-btn">Watch</button>
        `;
        container.appendChild(card);

        const btn = card.querySelector('.watch-btn');
        btn.addEventListener('click', () => openPlayer(channel.stream, channel.title, channel.logo));
      });
    }

    async function fetchSchedule() {
      const res = await fetch('https://ejgsapis.vercel.app/api/scrape?url=https://tvpass.org/tv_schedules/channels_tv_schedule.json');
      const data = await res.json();

      allChannels.forEach(channel => {
        const match = data.find(d => d.title && d.title.toLowerCase().includes(channel.title.toLowerCase()));
        if (match && match.next_programs) {
          const el = document.getElementById('sched-' + channel.title);
          const now = new Date();
          const current = match.next_programs.find(p => new Date(p['data-listdatetime']) <= now && new Date(now) < new Date(new Date(p['data-listdatetime']).getTime() + p['data-duration'] * 60000));
          if (current) {
            const end = new Date(new Date(current['data-listdatetime']).getTime() + current['data-duration'] * 60000);
            el.innerHTML = `<strong>${current['data-showname']}</strong><br><small>Until ${end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>`;
          }
        }
      });
      window.fullScheduleData = data; // Store for later use in player
    }

    function openPlayer(streamUrl, channelTitle, logoUrl) {
      // Hide main page and show player modal
      document.getElementById('mainPage').style.display = 'none';
      document.getElementById('playerModal').style.display = 'flex';
      const playerContainer = document.getElementById('player');
      playerContainer.innerHTML = '';
      if (window.currentArt && typeof window.currentArt.destroy === 'function') {
        window.currentArt.destroy();
        window.currentArt = null;
      }
      const bufferingFixEnabled = document.getElementById('bufferFixToggle').checked;
      const offset = bufferingFixEnabled ? 15 : 8;

      window.currentArt = new Artplayer({
        container: '#player',
        url: streamUrl,
        isLive: true,
        autoplay: true,
        fullscreenWeb: true,
        volume: 1.0,
        setting: true,
        poster: logoUrl,
        plugins: [
          artplayerPluginHlsControl({
            defaultQuality: 'auto',
            defaultAudio: 'auto',
            quality: {
              control: true,
              setting: true,
              getName: level => level.height + 'P',
              title: 'Quality',
              auto: 'Auto',
            },
            audio: {
              control: true,
              setting: true,
              getName: track => track.name,
              title: 'Audio',
              auto: 'Auto',
            },
          }),
        ],
        customType: {
          m3u8: function(video, url, art) {
            if (Hls.isSupported()) {
              if (art.hls) art.hls.destroy();
              const hls = new Hls();
              hls.loadSource(url);
              hls.attachMedia(video);
              art.hls = hls;
              art.on('destroy', () => hls.destroy());

              // Live offset logic (restored)
              const bufferingFixEnabled = document.getElementById('bufferFixToggle')?.checked;
              const offset = bufferingFixEnabled ? 15 : 8;
              const seekToLive = () => {
                if (!isNaN(video.duration)) {
                  video.currentTime = Math.max(video.duration - offset, 0);
                  video.removeEventListener('play', seekToLive);
                }
              };
              video.addEventListener('play', seekToLive, { once: true });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
              video.src = url;
            } else {
              art.notice.show = 'Unsupported playback format: m3u8';
            }
          }
        },
        type: 'm3u8',
      });

      document.getElementById('playerTitle').textContent = 'Now Playing - ' + channelTitle;

      // Find the schedule for the current channel and render sidebar
      if (window.fullScheduleData) {
        const match = window.fullScheduleData.find(d => d.title && d.title.toLowerCase().includes(channelTitle.toLowerCase()));
        if (match && match.next_programs) {
          currentSchedule = match.next_programs;
          renderScheduleSidebar(currentSchedule);
        } else {
          currentSchedule = null;
          renderScheduleSidebar([]);
        }
      }
      // Hide sidebar initially
      document.getElementById('scheduleSidebar').style.display = 'none';

      // Monitor delay and toggle Go Live button
      setInterval(() => {
        if (window.currentArt && window.currentArt.video && !isNaN(window.currentArt.video.duration)) {
          const diff = window.currentArt.video.duration - window.currentArt.video.currentTime;
          document.getElementById('goLiveBtn').style.display = (diff > 30) ? 'inline-block' : 'none';
        }
      }, 5000);
    }

    function closePlayer() {
      document.getElementById('playerModal').style.display = 'none';
      document.getElementById('mainPage').style.display = 'block';
      document.getElementById('player').innerHTML = '';
      document.getElementById('scheduleSidebar').style.display = 'none';
      document.getElementById('playerSettings').style.display = 'none';
    }

    function toggleSchedule() {
      const sidebar = document.getElementById('scheduleSidebar');
      sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
    }

    function closeSchedule() {
      document.getElementById('scheduleSidebar').style.display = 'none';
    }

    function renderScheduleSidebar(schedule) {
      const sidebar = document.getElementById('scheduleSidebar');
      const content = document.getElementById('scheduleContent');
      if (!schedule || schedule.length === 0) {
        content.innerHTML = '<h3>Upcoming</h3><div>No schedule available.</div>';
        return;
      }
      content.innerHTML = '<h3>Upcoming</h3>' + schedule.map(p =>
        `<div style="margin-bottom:1rem;"><strong>${p['data-showname']}</strong><br><small>${new Date(p['data-listdatetime']).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} – ${new Date(new Date(p['data-listdatetime']).getTime() + p['data-duration'] * 60000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small><br>${p['data-episodetitle']}</div>`
      ).join('');
    }

    function goLive() {
      if (window.currentArt && window.currentArt.video && !isNaN(window.currentArt.video.duration)) {
        const offset = document.getElementById('bufferFixToggle').checked ? 15 : 8;
        const liveTime = window.currentArt.video.duration - offset;
        if (liveTime > 0) {
          window.currentArt.video.currentTime = liveTime;
          window.currentArt.video.play();
          document.getElementById('goLiveBtn').style.display = 'none';
        }
      }
    }

    function toggleSettings() {
      const settings = document.getElementById('playerSettings');
      settings.style.display = settings.style.display === 'none' ? 'block' : 'none';
    }

    function applyTheme(theme) {
      const root = document.documentElement.style;
      if (theme === 'light') {
        root.setProperty('--bg', '#f1f1f1');
        root.setProperty('--card', '#ffffff');
        root.setProperty('--accent', '#2f81f7');
        root.setProperty('--text', '#0d1117');
        root.setProperty('--text-light', '#555');
      } else {
        root.setProperty('--bg', '#0d1117');
        root.setProperty('--card', '#161b22');
        root.setProperty('--accent', '#2f81f7');
        root.setProperty('--text', '#c9d1d9');
        root.setProperty('--text-light', '#8b949e');
      }
      localStorage.setItem('theme', theme);
    }

    function loadSettings() {
      const theme = localStorage.getItem('theme') || 'dark';
      document.getElementById('themeToggle').value = theme;
      applyTheme(theme);

      const buffering = localStorage.getItem('bufferFix') === 'true';
      document.getElementById('bufferFixToggle').checked = buffering;
    }

    document.getElementById('searchBox').addEventListener('input', e => {
      const query = e.target.value.toLowerCase();
      const filtered = allChannels.filter(ch => ch.title.toLowerCase().includes(query));
      renderChannels(filtered);
    });

    document.getElementById('viewToggle').addEventListener('change', e => {
      const grid = document.getElementById('channelGrid');
      grid.style.display = e.target.value === 'list' ? 'block' : 'grid';
    });

    document.getElementById('themeToggle').addEventListener('change', (e) => {
      applyTheme(e.target.value);
      localStorage.setItem('theme', e.target.value);
    });

    document.getElementById('bufferFixToggle').addEventListener('change', (e) => {
      localStorage.setItem('bufferFix', e.target.checked);
    });

    loadSettings();
    loadChannels();

    // Ensure the player modal is hidden on page load
    document.getElementById('playerModal').style.display = 'none';

    document.getElementById('scheduleCloseBtn').addEventListener('click', closeSchedule);
  </script>
</body>
</html>


