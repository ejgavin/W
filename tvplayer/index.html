<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TV Stream Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Rubik:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/artplayer@5.2.3/dist/artplayer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/artplayer-plugin-hls-control@latest/dist/artplayer-plugin-hls-control.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --accent: #2f81f7;
      --text: #c9d1d9;
      --text-light: #8b949e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Rubik', 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--card);
      padding: 1.5rem 2rem;
      font-size: 1.8rem;
      color: var(--accent);
      font-weight: 600;
      border-bottom: 2px solid var(--accent);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .controls {
      display: flex;
      gap: 1rem;
    }
    .controls input, .controls select {
      background: #21262d;
      color: var(--text);
      border: 1px solid #30363d;
      padding: 0.5rem;
      border-radius: 6px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
    }
    .card {
      background: var(--card);
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 1.2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      transition: transform 0.2s ease;
    }
    .card:hover {
      transform: translateY(-6px);
    }
    .card img {
      max-height: 60px;
      object-fit: contain;
      margin-bottom: 1rem;
    }
    .card h3 {
      font-size: 1.2rem;
      margin: 0 0 0.5rem;
      color: var(--accent);
    }
    .schedule {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-bottom: 1rem;
    }
    .watch-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }
    .watch-btn:hover {
      background: #1f6feb;
    }
    #playerModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: #000;
      z-index: 9999;
      flex-direction: column;
      position: relative;
    }
    #playerHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card);
      padding: 1rem;
      color: var(--text);
    }
    #playerHeader button {
      background: none;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    #playerHeader > div {
      display: flex;
      align-items: center;
    }
    #player {
      flex: 1;
      width: 100vw;
      height: 100%;
    }
    #scheduleSidebar {
      display:none;
      position:absolute;
      top:0;
      right:0;
      width:300px;
      height:100%;
      background:#161b22;
      color:#c9d1d9;
      overflow:auto;
      box-shadow:-4px 0 8px rgba(0,0,0,0.4);
      padding:1rem;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <header>
    Live TV Portal
    <div class="controls">
      <input type="text" id="searchBox" placeholder="Search channels...">
      <select id="viewToggle">
        <option value="grid">Grid View</option>
        <option value="list">List View</option>
      </select>
    </div>
  </header>
  <div class="grid" id="channelGrid"></div>
  <div id="playerModal">
    <div id="playerHeader">
      <span>Now Playing</span>
      <div>
        <button onclick="toggleSchedule()">Schedule</button>
        <button onclick="closePlayer()">Back</button>
      </div>
    </div>
    <div id="player"></div>
    <div id="scheduleSidebar" style="display:none; position:absolute; top:0; right:0; width:300px; height:100%; background:#161b22; color:#c9d1d9; overflow:auto; box-shadow:-4px 0 8px rgba(0,0,0,0.4); padding:1rem;"></div>
  </div>
  <script>
    let allChannels = [];
    let currentSchedule = null;

    async function loadChannels() {
      const res = await fetch('https://raw.githubusercontent.com/ejgavin/m3u8file/refs/heads/main/m3u8list.m3u8');
      const text = await res.text();
      const lines = text.split('\n');

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {
          const title = lines[i].split(',').pop().trim();
          const logoMatch = lines[i].match(/tvg-logo="(.*?)"/);
          const logo = logoMatch ? logoMatch[1] : '';
          const stream = lines[i + 1]?.trim();
          if (stream) {
            allChannels.push({ title, logo, stream });
          }
        }
      }
      renderChannels(allChannels);
      fetchSchedule();
    }

    function renderChannels(channels) {
      const container = document.getElementById('channelGrid');
      container.innerHTML = '';
      channels.forEach(channel => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${channel.logo}" alt="${channel.title}" />
          <h3>${channel.title}</h3>
          <div class="schedule" id="sched-${channel.title}">Loading schedule...</div>
          <button class="watch-btn" onclick="openPlayer('${channel.stream}', '${channel.title}')">Watch</button>
        `;
        container.appendChild(card);
      });
    }

    async function fetchSchedule() {
      const res = await fetch('https://ejgsapis.vercel.app/api/scrape?url=https://tvpass.org/tv_schedules/channels_tv_schedule.json');
      const data = await res.json();

      allChannels.forEach(channel => {
        const match = data.find(d => d.title && d.title.toLowerCase().includes(channel.title.toLowerCase()));
        if (match && match.next_programs) {
          const el = document.getElementById('sched-' + channel.title);
          const now = new Date();
          const current = match.next_programs.find(p => new Date(p['data-listdatetime']) <= now && new Date(now) < new Date(new Date(p['data-listdatetime']).getTime() + p['data-duration'] * 60000));
          if (current) {
            const end = new Date(new Date(current['data-listdatetime']).getTime() + current['data-duration'] * 60000);
            el.innerHTML = `<strong>${current['data-showname']}</strong><br><small>Until ${end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>`;
          }
        }
      });
      window.fullScheduleData = data; // Store for later use in player
    }

    function openPlayer(streamUrl, channelTitle) {
      document.getElementById('playerModal').style.display = 'flex';
      const art = new Artplayer({
        container: '#player',
        url: streamUrl,
        isLive: true,
        fullscreenWeb: true,
        setting: true,
        plugins: [
          artplayerPluginHlsControl({
            quality: {
              control: true,
              setting: true,
              getName: level => level.height + 'P',
              title: 'Quality',
              auto: 'Auto',
            },
            audio: {
              control: true,
              setting: true,
              getName: track => track.name,
              title: 'Audio',
              auto: 'Auto',
            },
          }),
        ],
        customType: {
          m3u8: function(video, url, art) {
            if (Hls.isSupported()) {
              if (art.hls) art.hls.destroy();
              const hls = new Hls();
              hls.loadSource(url);
              hls.attachMedia(video);
              art.hls = hls;
              art.on('destroy', () => hls.destroy());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
              video.src = url;
            } else {
              art.notice.show = 'Unsupported playback format: m3u8';
            }
          }
        },
        type: 'm3u8',
      });

      // Find the schedule for the current channel and render sidebar
      if (window.fullScheduleData) {
        const match = window.fullScheduleData.find(d => d.title && d.title.toLowerCase().includes(channelTitle.toLowerCase()));
        if (match && match.next_programs) {
          currentSchedule = match.next_programs;
          renderScheduleSidebar(currentSchedule);
        } else {
          currentSchedule = null;
          renderScheduleSidebar([]);
        }
      }
      // Hide sidebar initially
      document.getElementById('scheduleSidebar').style.display = 'none';
    }

    function closePlayer() {
      document.getElementById('playerModal').style.display = 'none';
      document.getElementById('player').innerHTML = '';
      document.getElementById('scheduleSidebar').style.display = 'none';
    }

    function toggleSchedule() {
      const sidebar = document.getElementById('scheduleSidebar');
      sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
    }

    function renderScheduleSidebar(schedule) {
      const sidebar = document.getElementById('scheduleSidebar');
      if (!schedule || schedule.length === 0) {
        sidebar.innerHTML = '<h3>Upcoming</h3><div>No schedule available.</div>';
        return;
      }
      sidebar.innerHTML = '<h3>Upcoming</h3>' + schedule.map(p =>
        `<div style="margin-bottom:1rem;"><strong>${p['data-showname']}</strong><br><small>${new Date(p['data-listdatetime']).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} â€“ ${new Date(new Date(p['data-listdatetime']).getTime() + p['data-duration'] * 60000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small><br>${p['data-episodetitle']}</div>`
      ).join('');
    }

    document.getElementById('searchBox').addEventListener('input', e => {
      const query = e.target.value.toLowerCase();
      const filtered = allChannels.filter(ch => ch.title.toLowerCase().includes(query));
      renderChannels(filtered);
    });

    document.getElementById('viewToggle').addEventListener('change', e => {
      const grid = document.getElementById('channelGrid');
      grid.style.display = e.target.value === 'list' ? 'block' : 'grid';
    });

    loadChannels();
  </script>
</body>
</html>
